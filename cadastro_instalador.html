<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cadastro de Instalador | Webartec</title>
  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <link rel="stylesheet" href="static/styles.css">
  <link rel="stylesheet" href="static/mobile-fixes.css">
  <link rel="stylesheet" href="static/ui-overrides.css">
  <style>
    .auth-card { max-width: 920px; margin: 0 auto; }
    .plan.card { display:block; cursor:pointer; }
    .plan.card input[type="radio"] { margin-right:8px; transform: translateY(1px); }
    .uf-wrap { display:flex; gap:10px; }
    .uf-wrap .w-2 { width: 140px; }
    @media (max-width: 900px){
      .uf-wrap { flex-direction: column; }
      .uf-wrap .w-2 { width: 100%; }
    }
  </style>
</head>
<body>
<header>
  <div class="container nav">
    <div class="brand">
      <a href="index.html" style="display:flex;align-items:center;gap:10px">
        <img src="assets/logo.png" alt="Webartec" style="height:28px">
        <strong>Webartec</strong>
      </a>
    </div>
    <div class="actions"><!-- session.js preenche quando logado --></div>
  </div>
</header>

<section class="section">
  <div class="container">
    <h2 class="title-xl">Cadastro de Instalador</h2>

    <div class="auth-card">
      <form id="installerForm" action="api/auth/register_installer.php" method="post" data-installer-form>
        <div class="grid-2">
          <div>
            <label>Seu nome</label>
            <input class="input" type="text" name="name" required>
          </div>
          <div>
            <label>E-mail</label>
            <input class="input" type="email" name="email" required>
          </div>

          <div>
            <label>Senha</label>
            <input class="input" type="password" name="password" required>
          </div>
          <div>
            <label>Empresa (nome fantasia)</label>
            <input class="input" type="text" name="company_name" placeholder="Ex.: Frio & Cia">
          </div>

          <div class="uf-wrap" style="grid-column: 1 / -1;">
            <div style="flex:1">
              <label>Cidade</label>
              <input class="input" type="text" name="city_only" placeholder="Ex.: Barueri" required>
            </div>
            <div class="w-2">
              <label>UF</label>
              <select class="input" name="uf" required>
                <option value="">Selecione</option>
                <option>AC</option><option>AL</option><option>AP</option><option>AM</option>
                <option>BA</option><option>CE</option><option>DF</option><option>ES</option>
                <option>GO</option><option>MA</option><option>MT</option><option>MS</option>
                <option>MG</option><option>PA</option><option>PB</option><option>PR</option>
                <option>PE</option><option>PI</option><option>RJ</option><option>RN</option>
                <option>RS</option><option>RO</option><option>RR</option><option>SC</option>
                <option>SP</option><option>SE</option><option>TO</option>
              </select>
            </div>
          </div>

          <div>
            <label>WhatsApp</label>
            <input class="input" type="text" name="whatsapp" placeholder="DDD + n√∫mero (somente d√≠gitos)">
          </div>
          <div>
            <label>Pre√ßo m√≠nimo (instala√ß√£o b√°sica)</label>
            <input class="input" type="text" inputmode="decimal" name="price" placeholder="ex.: 150,00">
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Servi√ßos</label><br>
          <label><input type="checkbox" name="services[]" value="instalacao"> Instala√ß√£o</label>
          <label><input type="checkbox" name="services[]" value="limpeza"> Limpeza</label>
          <label><input type="checkbox" name="services[]" value="higienizacao"> Higieniza√ß√£o</label>
          <label><input type="checkbox" name="services[]" value="manutencao"> Manuten√ß√£o</label>
          <label><input type="checkbox" name="services[]" value="preventiva"> Preventiva</label>
          <label><input type="checkbox" name="services[]" value="vrf"> VRF / Comercial</label>
        </div>

        <hr style="margin:16px 0;border:none;border-top:1px solid #E6ECF5">

        <div>
          <label>Escolha seu plano</label>
          <div class="grid-2">
            <label class="plan card" style="position:relative">
              <input type="radio" name="plan_choice" value="gratis" checked>
              <strong>Gr√°tis</strong>
              <div class="muted">Perfil b√°sico, 1 cidade, bot√£o WhatsApp.</div>
              <div class="price" id="p_gratis">R$ 0,00/m√™s</div>
            </label>

            <label class="plan card pop" style="position:relative">
              <input type="radio" name="plan_choice" value="destaque">
              <strong>Destaque</strong>
              <div class="muted">Topo da cidade, at√© 5 cidades, fotos e avalia√ß√µes.</div>
              <div class="price" id="p_destaque">R$ 79,90/m√™s</div>
              <span style="position:absolute;top:-12px;left:16px;background:#005BBF;color:#fff;padding:6px 10px;border-radius:8px;font-size:12px;font-weight:800;letter-spacing:.5px;">MAIS POPULAR</span>
            </label>
          </div>
          <p class="help">Pode come√ßar no Gr√°tis e fazer upgrade depois.</p>
        </div>

        <p style="margin-top:8px"><small>Ap√≥s criar, sua conta fica <strong>aguardando aprova√ß√£o</strong> do admin.</small></p>
        <button class="btn btn-blue" type="submit" style="margin-top:8px">Criar conta de Instalador</button>
        <p class="help" id="reg_status"></p>
      </form>
    </div>
  </div>
</section>

<footer class="footer">
  <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;">
    <div class="brand">
      <img src="assets/logo-white.png" alt="Webartec" style="height:22px;filter:invert(1)">
      <span>¬© 2025 Webartec ‚Ä¢ Todos os direitos reservados</span>
    </div>
  </div>
</footer>

<script src="static/session.js"></script>
<script>
(async function(){
  // 1) Pre√ßos globais (fallback local se API falhar)
  const fallbackPrices = { gratis: 0, destaque: 79.90 };
  try {
    const r = await fetch('api/plans/get.php', { credentials:'include' });
    if (r.ok) {
      const j = await r.json();
      const p = j.plans || {};
      const g = (typeof p.gratis === 'number') ? p.gratis : fallbackPrices.gratis;
      const d = (typeof p.destaque === 'number') ? p.destaque : fallbackPrices.destaque;
      document.getElementById('p_gratis').textContent   = 'R$ ' + g.toFixed(2).replace('.', ',') + '/m√™s';
      document.getElementById('p_destaque').textContent = 'R$ ' + d.toFixed(2).replace('.', ',') + '/m√™s';
    } else {
      document.getElementById('p_gratis').textContent   = 'R$ ' + fallbackPrices.gratis.toFixed(2).replace('.', ',') + '/m√™s';
      document.getElementById('p_destaque').textContent = 'R$ ' + fallbackPrices.destaque.toFixed(2).replace('.', ',') + '/m√™s';
    }
  } catch(e){
    document.getElementById('p_gratis').textContent   = 'R$ ' + fallbackPrices.gratis.toFixed(2).replace('.', ',') + '/m√™s';
    document.getElementById('p_destaque').textContent = 'R$ ' + fallbackPrices.destaque.toFixed(2).replace('.', ',') + '/m√™s';
  }

  // 2) Envio: cria conta e redireciona conforme plano escolhido
  const form = document.getElementById('installerForm');
  const status = document.getElementById('reg_status');

  form.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    status.textContent = '';

    const fd = new FormData(form);
    const payload = Object.fromEntries(fd.entries());
    payload.plan_choice = form.querySelector('input[name="plan_choice"]:checked')?.value || 'gratis';

    // servi√ßos m√∫ltiplos
    payload.services = Array
      .from(form.querySelectorAll('input[name="services[]"]:checked'))
      .map(x => x.value);

    // cidade + UF (armazenado como "Cidade (UF)")
    const cityOnly = (payload.city_only || '').trim();
    const uf = (payload.uf || '').trim();
    payload.city = cityOnly && uf ? `${cityOnly} (${uf})` : cityOnly;

    // pre√ßo (aceita v√≠rgula ou ponto)
    if (payload.price != null && String(payload.price).trim() !== '') {
      payload.price = parseFloat(String(payload.price).replace('.', '').replace(',', '.'));
      if (isNaN(payload.price)) payload.price = null;
    } else {
      payload.price = null;
    }

    try{
      const resp = await fetch('api/auth/register_installer.php', {
        method:'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials:'include',
        body: JSON.stringify(payload)
      });
      const data = await resp.json().catch(()=>({}));
      if (!resp.ok) {
        if (data && data.error === 'email_in_use') {
          status.textContent = 'Este e-mail j√° est√° cadastrado.'; return;
        }
        if (data && data.error === 'validation') {
          status.textContent = 'Preencha os campos obrigat√≥rios (nome, e-mail, senha).'; return;
        }
        status.textContent = 'Erro no cadastro. Tente novamente.'; return;
      }

      // üîÅ FOR√áA REDIRECIONAMENTO: se escolheu Destaque -> checkout hospedado (Mercado Pago)
      if (payload.plan_choice === 'destaque') {
        window.location.href = 'checkout.html?plan=destaque';
        return;
      }

      // Gr√°tis -> painel
      window.location.href = 'dashboard.html';
    } catch(e){
      status.textContent = 'Falha ao enviar. Verifique sua conex√£o.';
    }
  });
})();
</script>
</body>
</html>
